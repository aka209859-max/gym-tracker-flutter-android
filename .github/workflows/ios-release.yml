name: iOS TestFlight Release

on:
  workflow_dispatch:  
  push:
    tags:
      - 'v*'  

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.1'
          channel: 'stable'
      
      - name: Install dependencies
        run: |
          flutter pub get
          cd ios
          pod install
      
      - name: Install Apple Certificate and Provisioning Profile
        env:
          CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
          CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
          PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
        run: |
          security create-keychain -p "" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain
          
          echo "$CERTIFICATE_BASE64" | base64 --decode > certificate.p12
          security import certificate.p12 -k build.keychain -P "$CERTIFICATE_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
          security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain
          
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "$PROVISIONING_PROFILE_BASE64" | base64 --decode > profile.mobileprovision
          
          security cms -D -i profile.mobileprovision > profile.plist
          UUID=$(/usr/libexec/PlistBuddy -c 'Print :UUID' profile.plist)
          PROFILE_NAME=$(/usr/libexec/PlistBuddy -c 'Print :Name' profile.plist)
          TEAM_ID=$(/usr/libexec/PlistBuddy -c 'Print :TeamIdentifier:0' profile.plist)
          echo "ðŸ“‹ Extracted Profile UUID: $UUID"
          echo "ðŸ“‹ Extracted Profile Name: $PROFILE_NAME"
          echo "ðŸ“‹ Extracted Team ID: $TEAM_ID"
          
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/$UUID.mobileprovision
          
          # Export UUID for later steps
          echo "PROFILE_UUID=$UUID" >> $GITHUB_ENV
          echo "PROFILE_NAME=$PROFILE_NAME" >> $GITHUB_ENV
          echo "TEAM_ID=$TEAM_ID" >> $GITHUB_ENV
          
          echo "âœ… Certificate and provisioning profile installed"
      
      - name: Configure Xcode project for manual signing
        env:
          PROFILE_UUID: ${{ env.PROFILE_UUID }}
          PROFILE_NAME: ${{ env.PROFILE_NAME }}
          TEAM_ID: ${{ env.TEAM_ID }}
        run: |
          pip3 install --break-system-packages pbxproj
          
          python3 << 'PYTHON_SCRIPT'
          import sys
          import os
          from pbxproj import XcodeProject
          
          PROJECT_PATH = 'ios/Runner.xcodeproj/project.pbxproj'
          TEAM_ID = os.environ.get('TEAM_ID', 'AXZBK8B732')
          PROFILE_UUID = os.environ.get('PROFILE_UUID', '')
          PROFILE_NAME = os.environ.get('PROFILE_NAME', 'GymMatch AppStore Profile')
          
          print(f'Using Profile UUID: {PROFILE_UUID}')
          print(f'Using Profile Name: {PROFILE_NAME}')
          print(f'Using Team ID: {TEAM_ID}')
          
          try:
              print(f'Loading project: {PROJECT_PATH}')
              project = XcodeProject.load(PROJECT_PATH)
          except Exception as e:
              print(f'Failed to load project: {e}')
              sys.exit(1)
          
          print('Configuring build settings for manual signing...')
          
          modified_configs = 0
          for config in project.objects.get_objects_in_section('XCBuildConfiguration'):
              if hasattr(config, 'name') and ('Release' in config.name or 'Profile' in config.name):
                  print(f'  -> Modifying config: {config.name}')
                  if hasattr(config, 'buildSettings'):
                      settings = config.buildSettings
                      settings['CODE_SIGN_STYLE'] = 'Manual'
                      settings['DEVELOPMENT_TEAM'] = TEAM_ID
                      settings['PROVISIONING_PROFILE_SPECIFIER'] = PROFILE_UUID if PROFILE_UUID else PROFILE_NAME
                      settings['PROVISIONING_PROFILE'] = PROFILE_UUID if PROFILE_UUID else ''
                      settings['CODE_SIGN_IDENTITY'] = 'Apple Distribution'
                      modified_configs += 1
          
          if modified_configs == 0:
              print('Warning: No Release or Profile configurations found.')
          else:
              print(f'Modified {modified_configs} configurations.')
          
          print('Saving changes...')
          project.save()
          print('âœ… Xcode project configured for manual signing')
          PYTHON_SCRIPT
      
      - name: Create ExportOptions.plist
        env:
          PROFILE_UUID: ${{ env.PROFILE_UUID }}
          TEAM_ID: ${{ env.TEAM_ID }}
        run: |
          cat > ExportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store</string>
              <key>signingStyle</key>
              <string>manual</string>
              <key>provisioningProfiles</key>
              <dict>
                  <key>com.nexa.gymmatch</key>
                  <string>${PROFILE_UUID}</string>
              </dict>
              <key>signingCertificate</key>
              <string>Apple Distribution</string>
              <key>teamID</key>
              <string>${TEAM_ID}</string>
          </dict>
          </plist>
          EOF
          echo "âœ… ExportOptions.plist created with Team ID: ${TEAM_ID}, Profile UUID: ${PROFILE_UUID}"
      
      - name: Build Flutter IPA
        run: |
          flutter build ipa --release \
            --export-options-plist=ExportOptions.plist \
            --build-name=1.0.${{ github.run_number }} \
            --build-number=${{ github.run_number }}
      
      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: gym-match-${{ github.run_number }}.ipa
          path: build/ios/ipa/*.ipa
          retention-days: 30
      
      - name: Upload to App Store Connect
        env:
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_IDENTIFIER }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
        run: |
          mkdir -p ~/private_keys
          echo "$APP_STORE_CONNECT_KEY" > ~/private_keys/AuthKey_${APP_STORE_CONNECT_KEY_ID}.p8
          
          xcrun altool --upload-app \
            --type ios \
            --file build/ios/ipa/*.ipa \
            --apiKey "$APP_STORE_CONNECT_KEY_ID" \
            --apiIssuer "$APP_STORE_CONNECT_ISSUER_ID"
          
          echo "âœ… IPA uploaded to App Store Connect"
