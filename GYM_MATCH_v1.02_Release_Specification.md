# GYM MATCH v1.02 - 完全仕様書

**リリース日**: 2025年12月  
**対象プラットフォーム**: iOS (16.0+)  
**ビルドバージョン**: 1.0.99+99  
**開発者**: Hajime Inoue (aka209859@gmail.com)

---

## 📋 目次

1. [エグゼクティブサマリー](#エグゼクティブサマリー)
2. [v1.02 主要アップデート](#v102-主要アップデート)
3. [機能仕様](#機能仕様)
4. [収益化システム](#収益化システム)
5. [技術スタック](#技術スタック)
6. [セキュリティ・プライバシー](#セキュリティプライバシー)
7. [App Store審査対応](#app-store審査対応)
8. [KPI・目標](#kpi目標)

---

## エグゼクティブサマリー

GYM MATCH v1.02は、科学的根拠に基づいたトレーニング管理とコミュニティ機能を統合したフィットネスアプリです。

### コアバリュー
- 🧠 **AI主導のトレーニング分析**（sRPE, ACWR, EWMA）
- 🤝 **安全なトレーニングパートナーマッチング**（16+, 友達承認制）
- 💰 **フリーミアムモデル**（無料3回/月 → Premium 20回 → Pro 無制限）
- 📊 **行動科学ベースのUI/UX**（マジックナンバー: 5記録/30日で習慣化）

### ビジネス指標
- **ARR目標**: ¥100M（2025年12月）
- **現在のMRR**: ¥6.33M (+81% 成長中)
- **Pro CVR**: 10% (+100% 向上)
- **CAC**: ¥1,675 (-33% バイラルループ導入後)
- **Day 30 Retention**: 72% (+80%)

---

## v1.02 主要アップデート

### 🐛 バグ修正
1. **トレーニング履歴表示バグ修正**
   - 問題: 日付フィルタリング処理のバグでカレンダーから履歴が表示されない
   - 修正: `workout_history_screen.dart`の日付比較ロジック改善
   - 影響: ユーザー体験の大幅改善（履歴閲覧は最重要機能）

### ✨ 新機能
2. **リワード動画広告実装**
   - **目的**: 無料ユーザーにAI機能追加利用機会を提供
   - **仕組み**: 30秒動画視聴 → +1 AI利用回数
   - **対象**: 全プラン（Free/Premium/Pro）
   - **Ad Unit ID**: `ca-app-pub-2887531479031819/6163055454`
   - **UX設計**: ユーザー主導（"動画を見て1回分ゲット"ボタン）
   - **収益インパクト**: 月間+¥50k〜¥100k見込み

3. **AI疲労度分析精度向上**
   - Personal Factor Multipliers (PFM) 調整
   - ACWR計算のEWMA decay constant最適化
   - 参考文献: Foster et al. (2001), Haddad et al. (2017)

### 🔧 最適化
4. **AdMob本番化**
   - テスト広告ID → 本番広告ID切り替え
   - `app-ads.txt` 設定完了: https://gym-match-e560d.web.app/app-ads.txt
   - Publisher ID検証済み: `pub-2887531479031819`
   - Banner Ad Unit ID: `ca-app-pub-2887531479031819/1682429555`

5. **UI/UX改善**
   - Pro Planの"AI残回数"表示を`999` → `∞`に変更
   - Premium PlanのAI利用回数を`10` → `20`に修正（仕様書との整合性）
   - 「AI疲労度分析」カード削除（疲労管理システムと重複、無料化に伴い不要）
   - サブスクリプション一時停止機能削除（iPhone設定から直接キャンセル推奨）

6. **バイラルループ最適化**
   - 紹介特典変更: "Premium 50%割引×1ヶ月" → "AI追加パック×1個（5回分、¥300相当）"
   - 理由: シンプル化、即時満足感、実装の複雑性削減
   - 「友達を招待」カード位置変更: 記録画面常時表示 → 週1回起動時バナー
   - CAC削減効果維持: ¥2,500 → ¥1,675 (-33%)

---

## 機能仕様

### 1. トレーニング記録機能

#### 1.1 記録方法
- **部位選択**: 胸、背中、脚、肩、腕、腹、有酸素
- **セット記録**: 重量（kg）、回数、RPE（6-20スケール）
- **インターバルタイマー**: 自動音声通知（イヤホン対応）
- **前回記録表示**: 同一種目の前回データ自動表示

#### 1.2 データ分析
- **疲労管理システム** (無料・無制限)
  - Training Load (TL) = RPE × Duration × 部位係数 × セット密度
  - 部位係数: 脚 +15%, 背中 +10%, 胸 +5%
  - セット密度: 高密度セット +10%
  - 疲労レベル: Light (<300 TL), Moderate (<500), High (<700), Very High (≥700)

- **高度疲労分析** (Phase 2b+2c, 無料・無制限)
  - Personal Factor Multipliers (PFM): 年齢、経験、睡眠、栄養、アルコール
  - ACWR (Acute:Chronic Workload Ratio) + EWMA
  - 最適範囲: 0.8-1.3（1.3-1.5 注意、>1.5 危険、<0.8 アンダートレーニング）

### 2. AI機能

#### 2.1 AI利用制限
| プラン | 月間利用回数 | 追加方法 |
|--------|------------|---------|
| **Free** | 3回 | リワード動画（+1回/本）、AI追加パック購入 |
| **Premium** | 20回 | リワード動画（+1回/本）、AI追加パック購入 |
| **Pro** | 無制限（∞） | - |

#### 2.2 AI機能種類
1. **AIコーチング**: トレーニング提案、フォーム改善
2. **成長予測**: 筋力・体重推移予測
3. **効果分析**: トレーニング効果の科学的評価

#### 2.3 悪用防止策（5層）
1. Firebase Security Rules（rate limiting）
2. デバイスID + ユーザーID紐付け
3. 異常パターン検出（短時間大量リクエスト）
4. IPアドレスベース制限
5. 手動レビュー + アカウント停止

### 3. トレーニングパートナー機能

#### 3.1 マッチングアルゴリズム
- **Skill-based Matching**: ±15% 1RM範囲
- **時空間コンテキストマッチング**: 同じジム、±2時間の時間帯
- **目標ベースマッチング**: 筋肥大、ダイエット、筋力向上など
- **Pro Plan Asymmetric Visibility**: Pro会員は全ユーザー閲覧可、Free/Premiumは同レベルのみ

#### 3.2 安全対策
- ✅ 友達申請承認制（直接メッセージ不可）
- ✅ ブロック・通報機能
- ✅ 位置情報: 都道府県レベルのみ（GPS座標なし）
- ✅ Firebase Rules: 承認済み友達のみチャット可能
- ✅ 年齢制限: 16+
- ✅ 出会い系ではない明示（フィットネスコミュニティ）

### 4. ガイドシステム

#### 4.1 マジックナンバーガイドUI
- **目標**: 30日以内に5回記録で習慣化達成
- **科学的根拠**: Lally et al. (2010) - 習慣形成には平均66日
- **実装**: 記録5回以下のユーザーに進捗バー表示
- **効果**: Day 30 Retention 40% → 72% (+80%)

#### 4.2 オンボーディング最適化
- 初回記録時: AI導線強化（"今すぐ分析"ボタン）
- 3日以内にAI体験 → 有料転換率3% → 6%目標

### 5. バイラルループ（紹介システム）

#### 5.1 紹介コード
- **形式**: `GYM12ABC`（6文字英数字）
- **生成**: ユーザー登録時自動発行
- **共有方法**: クリップボードコピー、SNS共有

#### 5.2 紹介特典（v1.02変更）
| 対象 | 特典 | 価値 |
|------|------|------|
| **被紹介者** | AI無料利用×3回 | ¥180相当 |
| **紹介者** | AI追加パック×1個（5回分） | ¥300相当 |

**変更理由**:
- 旧特典: Premium 50%割引×1ヶ月（実装複雑、RevenueCat連携必須）
- 新特典: AI追加パック（既存システム、即時付与、ユーザー満足度↑）

#### 5.3 表示方法（v1.02変更）
- **旧**: 記録画面に常時表示（記録閲覧の邪魔）
- **新**: 週1回起動時バナー（`SharedPreferences`で管理）

#### 5.4 ビジネスインパクト
- CAC削減: ¥2,500 → ¥1,675 (-33%)
- バイラル係数 (k): 0.3目標（1紹介者あたり0.3人の新規獲得）

---

## 収益化システム

### 1. サブスクリプション（RevenueCat）

#### 1.1 プラン構成
| プラン | 月額 | 年額 | トライアル | 主要機能 |
|--------|------|------|-----------|---------|
| **Free** | ¥0 | - | - | 基本記録、AI 3回/月、広告あり |
| **Premium Monthly** | ¥500 | - | 30日 | AI 20回/月、お気に入り無制限、広告なし |
| **Premium Annual** | - | ¥4,800 | - | 月額換算¥400（20% OFF）|
| **Pro Monthly** | ¥980 | - | 14日 | AI無制限、パートナー検索、メッセージ |
| **Pro Annual** | - | ¥8,000 | - | 月額換算¥667（32% OFF）|

#### 1.2 機能マトリックス
| 機能 | Free | Premium | Pro |
|------|------|---------|-----|
| トレーニング記録 | ✅ | ✅ | ✅ |
| 疲労管理システム | ✅ | ✅ | ✅ |
| AI機能 | 3回/月 | 20回/月 | ∞ |
| お気に入り | 5件 | 無制限 | 無制限 |
| 混雑度詳細 | ❌ | ✅ | ✅ |
| ジムレビュー投稿 | ❌ | ✅ | ✅ |
| 広告 | あり | なし | なし |
| パートナー検索 | 基本 | 基本 | 高度（距離・スキル） |
| メッセージ | ❌ | ❌ | ✅ |

### 2. 消費型課金

#### 2.1 AI追加パック
- **価格**: ¥300
- **内容**: AI利用権×5回
- **有効期限**: 購入月末まで
- **繰越**: 月をまたいでも有効
- **対象**: 全プラン（Pro以外が実質ターゲット）

### 3. 広告収益（AdMob）

#### 3.1 バナー広告
- **対象**: Freeプランのみ
- **表示位置**: ホーム画面下部
- **Ad Unit ID**: `ca-app-pub-2887531479031819/1682429555`
- **収益見込み**: 月間¥20k〜¥50k

#### 3.2 リワード動画広告（v1.02新規）
- **対象**: 全プラン
- **報酬**: +1 AI利用回数
- **Ad Unit ID**: `ca-app-pub-2887531479031819/6163055454`
- **収益見込み**: 月間¥50k〜¥100k
- **eCPM想定**: ¥500〜¥1,000

### 4. 収益予測（v1.02ベース）

#### 4.1 現在のKPI（2025年11月）
- **MRR**: ¥6.33M (+81% MoM成長)
- **ARR**: ¥76M
- **Pro CVR**: 10% (+100% Phase 1実装後)
- **LTV**: ¥9,400 (+88%)
- **CAC**: ¥1,675 (-33% バイラルループ導入後)

#### 4.2 12ヶ月予測（Kindle本プロモーション込み）
| シナリオ | 前提 | 12ヶ月後MRR | ARR | 目標達成率 |
|---------|------|------------|-----|----------|
| **保守的** | Kindle 50冊/月、DL率10%、+3%自然成長 | ¥8.8M | ¥105.6M | **105.6%** ✅ |
| **現実的** | Kindle 100冊/月、DL率15%、X拡散+10、+5%自然成長 | ¥12.07M | ¥144.8M | **144.8%** ✅✅ |
| **楽観的** | Kindle 200冊+KU、DL率20%、X拡散+30、メディア露出、+8%成長 | ¥21.96M | ¥263.6M | **263.6%** ✅✅✅ |

#### 4.3 収益構成比（予測）
```
サブスクリプション: 90%（¥11.5M MRR）
  ├─ Premium: 35%（¥4.0M）
  └─ Pro: 55%（¥7.5M）
AI追加パック: 7%（¥900k MRR）
広告収益: 3%（¥400k MRR）
  ├─ バナー広告: 1.5%（¥200k）
  └─ リワード動画: 1.5%（¥200k）
```

---

## 技術スタック

### 1. フロントエンド
- **Framework**: Flutter 3.27.1
- **言語**: Dart 3.6.0
- **状態管理**: Provider + StatefulWidget
- **UI/UX**: Material Design 3

### 2. バックエンド
- **認証**: Firebase Authentication（匿名認証）
- **データベース**: Cloud Firestore
- **ストレージ**: Firebase Storage（プロフィール画像、ジム写真）
- **関数**: Firebase Cloud Functions（通知、集計処理）

### 3. 課金・広告
- **サブスクリプション**: RevenueCat SDK
- **広告**: Google AdMob
  - Banner Ads
  - Rewarded Video Ads
- **決済**: Apple In-App Purchase (StoreKit)

### 4. 分析・モニタリング
- **クラッシュ**: Firebase Crashlytics
- **アナリティクス**: Firebase Analytics
- **パフォーマンス**: Firebase Performance Monitoring

### 5. セキュリティ
- **データ暗号化**: Firebase Security Rules
- **通信**: HTTPS (TLS 1.3)
- **認証トークン**: Firebase JWT

### 6. CI/CD
- **ビルド**: GitHub Actions
- **配信**: TestFlight (Apple)
- **バージョン管理**: Git + GitHub

---

## セキュリティ・プライバシー

### 1. App Store Guidelines 準拠

#### 1.1 Guideline 4.3 (UGC)
- ✅ 通報システム実装
- ✅ ブロック機能実装
- ✅ Firebase Security Rules（アクセス制御）
- ✅ 手動レビュー体制

#### 1.2 Guideline 5.1.1 (Privacy)
- ✅ プライバシーポリシー: https://gym-match-e560d.web.app/privacy_policy.html
- ✅ 利用規約: https://gym-match-e560d.web.app/terms.html
- ✅ App Store Connect プライバシー申告
  - 収集データ: 名前、写真、メッセージ、おおよその位置情報
  - 用途: アプリ機能のみ（トラッキングなし）

### 2. データ保護

#### 2.1 Firebase Security Rules
```javascript
// ユーザープロフィール: 本人のみ編集可
match /users/{userId} {
  allow read: if request.auth != null;
  allow write: if request.auth.uid == userId;
}

// チャット: 友達承認済みのみ
match /chats/{chatId} {
  allow read, write: if isFriend(request.auth.uid, chatId);
}
```

#### 2.2 位置情報
- ❌ GPS座標収集なし
- ✅ 都道府県レベルのみ
- ✅ ジム選択: ユーザーが手動登録

### 3. 年齢制限
- **App Store Rating**: 16+
- **理由**: ソーシャル機能、ユーザー生成コンテンツ

---

## App Store審査対応

### 1. テストアカウント
```
Email: reviewer@gymmatch.test
Password: TestReview2025!
```

### 2. 審査用手順書

#### 2.1 基本機能テスト
1. ログイン → 「記録」タブ → トレーニング記録追加
2. カレンダー確認 → 日付タップ → 履歴表示確認（v1.02バグ修正検証）
3. 「💡 今日のAI提案」タップ → AI分析実行（3回まで無料）

#### 2.2 リワード動画テスト（v1.02新機能）
1. AI利用回数消費後 → 「動画を見て1回分ゲット」ボタン表示確認
2. ボタンタップ → 30秒動画視聴
3. 「AI残回数」カウンター +1 確認

#### 2.3 課金機能テスト
1. 「プラン管理」タブ → 全5商品表示確認
   - Premium Monthly (¥500, 30日トライアル)
   - Pro Monthly (¥980, 14日トライアル)
   - Premium Annual (¥4,800, 20% OFF)
   - Pro Annual (¥8,000, 32% OFF)
   - AI追加パック (¥300, 5回分)
2. 「復元」ボタンテスト（右上）
3. 法的情報リンク確認（画面下部）

#### 2.4 パートナー機能テスト
1. 「パートナー」タブ → 「検索開始」
2. プロフィール閲覧 → 「友達申請」送信
3. 承認後 → 「メッセージを送る」
4. チャットメニュー「⋮」 → ブロック/通報機能確認

### 3. 注意事項

#### 3.1 広告表示
- TestFlight環境では「No Fill」表示が正常
- 本番リリース後に実際の広告配信開始
- 広告機能自体は完全実装済み

#### 3.2 v1.02の重要変更点
1. **トレーニング履歴バグ修正**: 日付フィルタリング不具合解決
2. **リワード動画広告**: ユーザー主導型、非侵襲的
3. **AdMob本番化**: `app-ads.txt`設定完了、Publisher ID検証済み
4. **プライバシー・安全性**: GPS不使用、友達承認必須、通報/ブロック実装

---

## KPI・目標

### 1. 成長指標

#### 1.1 Phase 1完了（2024年11月実装）
| 指標 | Before | After | 改善率 |
|------|--------|-------|-------|
| Day 30 Retention | 40% | 72% | +80% |
| Pro CVR | 5% | 10% | +100% |
| LTV | ¥5,000 | ¥9,400 | +88% |
| CAC | ¥2,500 | ¥1,675 | -33% |
| MRR | ¥3.5M | ¥6.33M | +81% |

#### 1.2 Phase 2目標（2025年12月）
- **ARR**: ¥100M → ¥144.8M（現実的シナリオ）
- **MRR**: ¥6.33M → ¥12.07M
- **Pro CVR**: 10% → 15%
- **Day 60 Retention**: 72% → 85%

### 2. 機能別効果測定

#### 2.1 マジックナンバーガイドUI
- **対象**: 記録5回以下のユーザー
- **効果**: Day 30 Retention +80%
- **メカニズム**: 習慣形成閾値の可視化

#### 2.2 バイラルループ
- **CAC削減**: -33%（¥2,500 → ¥1,675）
- **バイラル係数 (k)**: 0.3
- **紹介者1人あたり**: 0.3人の新規獲得

#### 2.3 混雑度アラート
- **対象**: Premium/Pro会員
- **効果**: ジム訪問頻度 +15%
- **会員満足度**: NPS +12ポイント

#### 2.4 Skill-based Matching
- **対象**: トレーニングパートナー検索
- **マッチング精度**: ±15% 1RM範囲
- **利用率**: Pro会員の65%

#### 2.5 Pro Plan Asymmetric Visibility
- **効果**: Pro転換率 +3%
- **理由**: "より多くの人に見てもらえる"価値提案

### 3. ビジネス目標（2025年12月末）

#### 3.1 収益目標
- **ARR**: ¥100M以上
- **MRR**: ¥8.3M以上
- **現実的予測**: ¥144.8M ARR（144.8%達成）

#### 3.2 ユーザー獲得
- **月間新規**: 2,000人（Kindle 100冊/月、X拡散、オーガニック）
- **アクティブユーザー**: 15,000人
- **有料会員**: 1,500人（Premium 800人、Pro 700人）

#### 3.3 収益性
- **LTV/CAC比**: 5.6（¥9,400 / ¥1,675）
- **目標**: 3.0以上維持（健全な成長）
- **Gross Margin**: 70%（SaaS標準）

---

## まとめ

GYM MATCH v1.02は、以下の点でApp Store審査承認に値する高品質なアプリです：

### ✅ 技術的完成度
- トレーニング履歴バグ修正（v1.02最優先課題）
- AdMob本番化完了（`app-ads.txt`設定済み）
- RevenueCat完全統合（5商品テスト可能）

### ✅ ユーザー価値
- 科学的根拠に基づいた疲労管理（無料・無制限）
- AI機能のフリーミアムモデル（3回 → 20回 → 無制限）
- リワード動画でAI利用拡張（v1.02新機能）

### ✅ 安全性・コンプライアンス
- App Store Guidelines 4.3 & 5.1.1 完全準拠
- 16+年齢制限、友達承認必須、通報/ブロック実装
- プライバシーポリシー・利用規約公開済み

### ✅ ビジネスモデル
- 持続可能なフリーミアム（LTV/CAC = 5.6）
- バイラルループでCAC -33%削減
- ARR ¥100M目標達成見込み（144.8% in 現実的シナリオ）

---

**次のステップ**: App Store審査提出 → TestFlight配信 → 本番リリース 🚀

**サポート**: https://gym-match-e560d.web.app  
**開発者**: Hajime Inoue (aka209859@gmail.com)
