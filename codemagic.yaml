workflows:
  ios-release:
    name: "GYM MATCH iOS Release"
    max_build_duration: 30
    instance_type: mac_mini_m2
    
    environment:
      ios_signing:
        distribution_type: app_store
        bundle_identifier: com.nexa.gymmatch
      
      # ğŸ”‘ ç’°å¢ƒå¤‰æ•°ã‚°ãƒ«ãƒ¼ãƒ—ã‚’æ˜ç¤ºçš„ã«èª­ã¿è¾¼ã‚€
      groups:
        - app_store_credentials
      
      vars:
        PROJECT_ROOT: $CM_BUILD_DIR
        # ğŸ”‘ App Store Connect API credentials (set in Codemagic UI)
        APP_STORE_CONNECT_ISSUER_ID: 089530c4-f36e-4828-8198-eec5ae23ad19
        APP_STORE_CONNECT_KEY_IDENTIFIER: DFXAU88R2R
        # APP_STORE_CONNECT_PRIVATE_KEY: Set as secure variable in Codemagic UI
      
      flutter: stable
      xcode: latest
      cocoapods: default
    
    scripts:
      - name: Clean Flutter
        script: |
          flutter clean
          flutter pub get
      
      - name: Clean CocoaPods cache and force fresh install
        script: |
          echo "ğŸ§¹ Cleaning iOS Pod environment..."
          cd ios
          rm -rf Podfile.lock Pods
          pod install --repo-update
          cd ..
          echo "âœ… Pod environment cleanup and update completed"
      
      - name: Install Pods
        script: |
          cd ios
          pod install
          cd ..
      
      # ğŸ” ã€ãƒ•ãƒ«ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ç½²åã€‘å€‹äººã‚¢ã‚«ã‚¦ãƒ³ãƒˆAPIã‚­ãƒ¼åˆ¶é™ã®å›é¿
      - name: Set up keychain
        script: |
          keychain initialize
      
      - name: Decode and install Distribution Certificate
        script: |
          # Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸè¨¼æ˜æ›¸ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã—ã¾ã™
          echo $APP_STORE_CERTIFICATE | base64 --decode > $CM_BUILD_DIR/distribution_cert.p12
          
          # è¨¼æ˜æ›¸ã‚’ä¸€æ™‚ã‚­ãƒ¼ãƒã‚§ãƒ¼ãƒ³ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™
          keychain add-certificates \
            --certificate $CM_BUILD_DIR/distribution_cert.p12 \
            --certificate-password "$CERTIFICATE_PASSWORD"
      
      - name: Decode and install App Store Provisioning Profile
        script: |
          # Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã—ã¾ã™
          echo $APP_STORE_PROFILE | base64 --decode > $CM_BUILD_DIR/app_store.mobileprovision
          
          # xcodebuildãŒè¦‹ã¤ã‘ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã€ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ­£ã—ã„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™
          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          cp $CM_BUILD_DIR/app_store.mobileprovision "$HOME/Library/MobileDevice/Provisioning Profiles/"
      
      # æ³¨: xcode-project use-profiles ã¯ã€Œå€‹äººã€APIã‚­ãƒ¼ã§ã¯æ©Ÿèƒ½ã—ãªã„ãŸã‚å‰Šé™¤
      
      - name: Flutter build
        script: |
          flutter build ios --release --no-codesign \
            --build-name=1.0.$PROJECT_BUILD_NUMBER \
            --build-number=$PROJECT_BUILD_NUMBER
      
      - name: Xcode archive
        script: |
          # æ‰‹å‹•ç½²åã‚’å¼·åˆ¶
          set -x
          xcodebuild archive \
            -workspace ios/Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -archivePath $CM_BUILD_DIR/Runner.xcarchive \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            PROVISIONING_PROFILE_SPECIFIER="match AppStore com.nexa.gymmatch"
      
      - name: Xcode export IPA
        script: |
          # æ‰‹å‹•ç½²åç”¨ã®plistã‚’ä½¿ç”¨ï¼ˆios/ExportOptions.plistï¼‰
          # -allowProvisioningUpdates ã¯å‰Šé™¤ï¼ˆAPIå‘¼ã³å‡ºã—ã‚’é˜²ãï¼‰
          set -x
          xcodebuild -exportArchive \
            -archivePath $CM_BUILD_DIR/Runner.xcarchive \
            -exportPath $CM_BUILD_DIR/ipa \
            -exportOptionsPlist ios/ExportOptions.plist
          
          echo "âœ… IPA export completed"
      
      # âœ… ã€æ¤œè¨¼ã€‘IPAãŒç”Ÿæˆã•ã‚ŒãŸã‹ç¢ºèª
      - name: Verify IPA exists
        script: |
          echo "Verifying IPA file presence..."
          IPA_FILE=$(find $CM_BUILD_DIR/ipa -name "*.ipa" | head -n 1)
          if [ -z "$IPA_FILE" ]; then
            echo "::error:: IPA file not found"
            ls -la $CM_BUILD_DIR/ipa
            exit 1
          fi
          echo "âœ… IPA found: $IPA_FILE"
    
    artifacts:
      - $CM_BUILD_DIR/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
      - flutter_drive.log
    
    publishing:
      # ğŸ“§ Eãƒ¡ãƒ¼ãƒ«é€šçŸ¥ (ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆãŒæ•æ‰ã•ã‚Œã‚‹ãŸã‚ã€ä»Šåº¦ã¯ãƒªãƒ³ã‚¯ãŒé€ä¿¡ã•ã‚Œã‚‹)
      email:
        recipients:
          - aka209859@gmail.com
        notify:
          success: true
          failure: true
      
      # ğŸš€ ã€æœ€çµ‚ç›®çš„ã€‘TestFlightã¸ã®è‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      # App Store Connect APIèªè¨¼æƒ…å ±ã‚’ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—
      app_store_connect:
        # ğŸ”‘ App Store Connect APIèªè¨¼æƒ…å ±
        api_key: $APP_STORE_CONNECT_PRIVATE_KEY
        key_id: $APP_STORE_CONNECT_KEY_IDENTIFIER
        issuer_id: $APP_STORE_CONNECT_ISSUER_ID
        
        # TestFlightã¸ã®è‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        submit_to_testflight: true
        
        # (ã‚ªãƒ—ã‚·ãƒ§ãƒ³) ç‰¹å®šã®ãƒ™ãƒ¼ã‚¿ã‚°ãƒ«ãƒ¼ãƒ—ã«å³æ™‚é…å¸ƒ
        # beta_groups:
        #   - "Internal Testers"
        #   - "External Testers"
