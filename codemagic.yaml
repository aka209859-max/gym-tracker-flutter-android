workflows:
  ios-release:
    name: "GYM MATCH iOS Release"
    max_build_duration: 30
    instance_type: mac_mini_m2
    
    environment:
      ios_signing:
        distribution_type: app_store
        bundle_identifier: com.nexa.gymmatch
      
      # ğŸ”‘ ç’°å¢ƒå¤‰æ•°ã‚°ãƒ«ãƒ¼ãƒ—ã‚’æ˜ç¤ºçš„ã«èª­ã¿è¾¼ã‚€
      groups:
        - app_store_credentials
      
      vars:
        PROJECT_ROOT: $CM_BUILD_DIR
        # ğŸ”‘ App Store Connect API credentials (set in Codemagic UI)
        APP_STORE_CONNECT_ISSUER_ID: 089530c4-f36e-4828-8198-eec5ae23ad19
        APP_STORE_CONNECT_KEY_IDENTIFIER: DFXAU88R2R
        # APP_STORE_CONNECT_PRIVATE_KEY: Set as secure variable in Codemagic UI
      
      flutter: stable
      xcode: latest
      cocoapods: default
    
    scripts:
      - name: Clean Flutter
        script: |
          flutter clean
          flutter pub get
      
      - name: Clean CocoaPods cache and force fresh install
        script: |
          echo "ğŸ§¹ Cleaning iOS Pod environment..."
          cd ios
          rm -rf Podfile.lock Pods
          pod install --repo-update
          cd ..
          echo "âœ… Pod environment cleanup and update completed"
      
      - name: Install Pods
        script: |
          cd ios
          pod install
          cd ..
      
      # ğŸ”‘ ã€é‡è¦ã€‘Xcodeã®è‡ªå‹•ã‚³ãƒ¼ãƒ‰ç½²åã‚’ä½¿ç”¨
      # App Store Connect APIã‚’ä½¿ã£ã¦è‡ªå‹•çš„ã«è¨¼æ˜æ›¸ã¨ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç®¡ç†
      - name: Set up code signing settings on Xcode project
        script: |
          xcode-project use-profiles
      
      # ğŸš€ ã€é‡è¦ã€‘Flutterãƒ“ãƒ«ãƒ‰ã¨ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä½œæˆ
      - name: Build and Archive iOS app
        script: |
          # Flutterä¾å­˜é–¢ä¿‚ã¨ã‚¢ã‚»ãƒƒãƒˆã‚’ãƒ“ãƒ«ãƒ‰
          flutter build ios --release --no-codesign \
            --build-name=1.0.$PROJECT_BUILD_NUMBER \
            --build-number=$PROJECT_BUILD_NUMBER
          
          # Xcodeã§ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’ä½œæˆ
          ARCHIVE_PATH="$PROJECT_ROOT/build/ios/Runner.xcarchive"
          
          xcodebuild archive \
            -workspace ios/Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -archivePath "$ARCHIVE_PATH" \
            -allowProvisioningUpdates \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            DEVELOPMENT_TEAM=7V5DA99X2M
          
          echo "âœ… Archive created at: $ARCHIVE_PATH"
      
      # ğŸ“¦ ã€IPAã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã€‘
      - name: Export IPA from archive
        script: |
          set -e  # ã‚¨ãƒ©ãƒ¼ã§å³åº§ã«åœæ­¢
          set -x  # ã‚³ãƒãƒ³ãƒ‰ã‚’ãƒ­ã‚°å‡ºåŠ›
          
          ARCHIVE_PATH="$PROJECT_ROOT/build/ios/Runner.xcarchive"
          EXPORT_PATH="$PROJECT_ROOT/build/ios/ipa"
          
          # ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã®å­˜åœ¨ç¢ºèª
          if [ ! -d "$ARCHIVE_PATH" ]; then
            echo "::error:: Archive not found at $ARCHIVE_PATH"
            ls -la "$PROJECT_ROOT/build/ios/"
            exit 1
          fi
          
          echo "âœ… Archive found at: $ARCHIVE_PATH"
          
          # ExportOptions.plistã‚’ä½œæˆ
          cat > /tmp/ExportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store</string>
              <key>teamID</key>
              <string>7V5DA99X2M</string>
              <key>uploadSymbols</key>
              <true/>
              <key>compileBitcode</key>
              <false/>
              <key>signingStyle</key>
              <string>automatic</string>
              <key>provisioningProfiles</key>
              <dict>
                  <key>com.nexa.gymmatch</key>
                  <string>match AppStore com.nexa.gymmatch</string>
              </dict>
          </dict>
          </plist>
          EOF
          
          echo "ğŸ“„ ExportOptions.plist created:"
          cat /tmp/ExportOptions.plist
          
          # IPAã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
          mkdir -p "$EXPORT_PATH"
          
          echo "ğŸš€ Starting xcodebuild -exportArchive..."
          xcodebuild -exportArchive \
            -archivePath "$ARCHIVE_PATH" \
            -exportPath "$EXPORT_PATH" \
            -exportOptionsPlist /tmp/ExportOptions.plist \
            -allowProvisioningUpdates \
            2>&1 | tee /tmp/export.log
          
          EXPORT_EXIT_CODE=${PIPESTATUS[0]}
          
          if [ $EXPORT_EXIT_CODE -ne 0 ]; then
            echo "::error:: xcodebuild -exportArchive failed with exit code $EXPORT_EXIT_CODE"
            echo "Export log:"
            cat /tmp/export.log
            exit $EXPORT_EXIT_CODE
          fi
          
          # IPAå­˜åœ¨ç¢ºèª
          IPA_FILE=$(find "$EXPORT_PATH" -name "*.ipa" | head -n 1)
          if [ -z "$IPA_FILE" ]; then
            echo "::error:: IPA file not found after export"
            ls -la "$EXPORT_PATH"
            exit 1
          fi
          
          echo "âœ… IPA exported successfully: $IPA_FILE"
      
      # âœ… ã€æ¤œè¨¼ã€‘ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ï¼šIPAãŒå®Ÿéš›ã«ç”Ÿæˆã•ã‚ŒãŸã‹æ¤œè¨¼
      # ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆãŒç„¡ã„ã¾ã¾å¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã‚€ã®ã‚’é˜²ã
      - name: Verify IPA exists
        script: |
          echo "Verifying IPA file presence..."
          # Flutter 3.xã§ã¯IPAã¯è¤‡æ•°ã®å ´æ‰€ã«ç”Ÿæˆã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹
          IPA_PATH=$(find "$PROJECT_ROOT/build/ios" -name "*.ipa" | head -n 1)
          if [ -z "$IPA_PATH" ]; then
            echo "::error:: IPA file was not generated"
            echo "Checking build output structure:"
            ls -R "$PROJECT_ROOT/build/ios/" || echo "build/ios directory not found"
            exit 1
          else
            echo "âœ… IPA found at: $IPA_PATH"
            # æ¨™æº–çš„ãªå ´æ‰€ã«ã‚³ãƒ”ãƒ¼ï¼ˆã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆåé›†ã‚’ç¢ºå®Ÿã«ã™ã‚‹ï¼‰
            mkdir -p "$PROJECT_ROOT/build/ios/ipa"
            cp "$IPA_PATH" "$PROJECT_ROOT/build/ios/ipa/"
            echo "âœ… IPA copied to: $PROJECT_ROOT/build/ios/ipa/"
          fi
    artifacts:
      - build/ios/ipa/*.ipa
      - build/ios/**/*.ipa
      - /tmp/xcodebuild_logs/*.log
      - flutter_drive.log
    publishing:
      # ğŸ“§ Eãƒ¡ãƒ¼ãƒ«é€šçŸ¥ (ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆãŒæ•æ‰ã•ã‚Œã‚‹ãŸã‚ã€ä»Šåº¦ã¯ãƒªãƒ³ã‚¯ãŒé€ä¿¡ã•ã‚Œã‚‹)
      email:
        recipients:
          - aka209859@gmail.com
        notify:
          success: true
          failure: true
      
      # ğŸš€ ã€æœ€çµ‚ç›®çš„ã€‘TestFlightã¸ã®è‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      # App Store Connect APIèªè¨¼æƒ…å ±ã‚’ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—
      app_store_connect:
        # ğŸ”‘ App Store Connect APIèªè¨¼æƒ…å ±
        api_key: $APP_STORE_CONNECT_PRIVATE_KEY
        key_id: $APP_STORE_CONNECT_KEY_IDENTIFIER
        issuer_id: $APP_STORE_CONNECT_ISSUER_ID
        
        # TestFlightã¸ã®è‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        submit_to_testflight: true
        
        # (ã‚ªãƒ—ã‚·ãƒ§ãƒ³) ç‰¹å®šã®ãƒ™ãƒ¼ã‚¿ã‚°ãƒ«ãƒ¼ãƒ—ã«å³æ™‚é…å¸ƒ
        # beta_groups:
        #   - "Internal Testers"
        #   - "External Testers"
