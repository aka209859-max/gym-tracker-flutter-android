workflows:
  ios-release:
    name: "GYM MATCH iOS Release"
    max_build_duration: 30
    instance_type: mac_mini_m2
    
    environment:
      groups:
        - app_store_credentials      # TestFlight ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”¨
        - manual_code_signing         # æ‰‹å‹•ç½²åç”¨ï¼ˆæ–°è¦è¿½åŠ ï¼‰
      
      vars:
        PROJECT_ROOT: $CM_BUILD_DIR
        BUNDLE_ID: com.nexa.gymmatch
      
      flutter: stable
      xcode: latest
      cocoapods: default
    
    scripts:
      - name: Clean Flutter
        script: |
          flutter clean
          flutter pub get
      
      - name: Clean CocoaPods cache and force fresh install
        script: |
          echo "ğŸ§¹ Cleaning iOS Pod environment..."
          cd ios
          rm -rf Podfile.lock Pods
          pod install --repo-update
          cd ..
          echo "âœ… Pod environment cleanup and update completed"
      
      - name: Install Pods
        script: |
          cd ios
          pod install
          cd ..
      
      # ğŸ” ã€é‡è¦ã€‘Keychainã‚’åˆæœŸåŒ–
      - name: Set up keychain
        script: |
          keychain initialize
      
      # ğŸ” ã€é‡è¦ã€‘Provisioning Profileã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆUUIDä¿®æ­£ç‰ˆï¼‰
      - name: Decode and install provisioning profile
        script: |
          set -x
          PROFILES_HOME="$HOME/Library/MobileDevice/Provisioning Profiles"
          mkdir -p "$PROFILES_HOME"
          
          # ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ‡ã‚³ãƒ¼ãƒ‰
          echo "${CM_PROVISIONING_PROFILE}" | base64 --decode > /tmp/profile.mobileprovision
          
          # ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«å†…ã‹ã‚‰UUIDã‚’æŠ½å‡º
          PROFILE_UUID=$(security cms -D -i /tmp/profile.mobileprovision | grep -A1 '<key>UUID</key>' | grep '<string>' | sed 's/.*<string>\(.*\)<\/string>.*/\1/')
          
          echo "ğŸ“‹ Extracted Profile UUID: $PROFILE_UUID"
          
          # UUIDã‚’ãƒ•ã‚¡ã‚¤ãƒ«åã«ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          PROFILE_PATH="$PROFILES_HOME/$PROFILE_UUID.mobileprovision"
          cp /tmp/profile.mobileprovision "$PROFILE_PATH"
          
          echo "âœ… Installed profile to $PROFILE_PATH"
          
          # ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’ç¢ºèª
          security cms -D -i "$PROFILE_PATH" | grep -A2 '<key>Name</key>' || true
      
      # ğŸ” ã€é‡è¦ã€‘è¨¼æ˜æ›¸ã‚’Keychainã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Decode and install certificate
        script: |
          set -x
          echo "$CM_CERTIFICATE" | base64 --decode > /tmp/certificate.p12
          keychain add-certificates \
            --certificate /tmp/certificate.p12 \
            --certificate-password "$CM_CERTIFICATE_PASSWORD"
          echo "âœ… Certificate installed to keychain"
      
      # ğŸ”§ ã€é‡è¦ã€‘Xcodeãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æ‰‹å‹•ç½²åã«è¨­å®š
      - name: Configure manual code signing in Xcode project
        script: |
          set -x
          python3 << 'PYTHON_SCRIPT'
          import re
          
          project_path = "ios/Runner.xcodeproj/project.pbxproj"
          
          with open(project_path, 'r') as f:
              content = f.read()
          
          # Releaseè¨­å®šï¼ˆ97C147071CF9000F007C117Dï¼‰ã‚’æ¢ã—ã¦æ‰‹å‹•ç½²åè¨­å®šã‚’è¿½åŠ 
          pattern = r'(97C147071CF9000F007C117D /\* Release \*/.*?buildSettings = \{[^\}]*?VERSIONING_SYSTEM = "apple-generic";)'
          
          replacement = r'\1\n\t\t\t\tCODE_SIGN_STYLE = Manual;\n\t\t\t\tCODE_SIGN_IDENTITY = "Apple Distribution";\n\t\t\t\tDEVELOPMENT_TEAM = AXZBK8B732;\n\t\t\t\tPROVISIONING_PROFILE_SPECIFIER = "GymMatch AppStore Profile";'
          
          content = re.sub(pattern, replacement, content, flags=re.DOTALL)
          
          with open(project_path, 'w') as f:
              f.write(content)
          
          print("âœ… Xcode project configured for manual signing")
          PYTHON_SCRIPT
      
      # ğŸ” ã€é‡è¦ã€‘ExportOptionsã‚’ç”Ÿæˆ
      - name: Create ExportOptions.plist
        script: |
          cat > /tmp/ExportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store</string>
              <key>signingStyle</key>
              <string>manual</string>
              <key>provisioningProfiles</key>
              <dict>
                  <key>com.nexa.gymmatch</key>
                  <string>GymMatch AppStore Profile</string>
              </dict>
              <key>signingCertificate</key>
              <string>Apple Distribution</string>
              <key>teamID</key>
              <string>AXZBK8B732</string>
          </dict>
          </plist>
          EOF
          echo "âœ… ExportOptions.plist created"
      
      # ğŸš€ ã€é‡è¦ã€‘Flutterã«ã‚ˆã‚‹IPAã®ãƒ“ãƒ«ãƒ‰ï¼ˆæ‰‹å‹•ç½²åï¼‰
      - name: Flutter build ipa
        script: |
          flutter build ipa --release \
            --export-options-plist=/tmp/ExportOptions.plist \
            --build-name=1.0.$PROJECT_BUILD_NUMBER \
            --build-number=$PROJECT_BUILD_NUMBER
      
      # âœ… ã€æ¤œè¨¼ã€‘IPAãŒå®Ÿéš›ã«ç”Ÿæˆã•ã‚ŒãŸã‹æ¤œè¨¼
      - name: Verify IPA exists
        script: |
          echo "Verifying IPA file presence..."
          IPA_PATH=$(find "$PROJECT_ROOT/build/ios/ipa" -name "*.ipa" | head -n 1)
          if [ -z "$IPA_PATH" ]; then
            echo "::error:: IPA file was not generated in build/ios/ipa/"
            exit 1
          else
            echo "âœ… IPA found at: $IPA_PATH"
          fi
    
    artifacts:
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
      - flutter_drive.log
    
    publishing:
      # ğŸ“§ Eãƒ¡ãƒ¼ãƒ«é€šçŸ¥
      email:
        recipients:
          - aka209859@gmail.com
        notify:
          success: true
          failure: true
      
      # ğŸš€ ã€æœ€çµ‚ç›®çš„ã€‘TestFlightã¸ã®è‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      app_store_connect:
        api_key: $APP_STORE_CONNECT_PRIVATE_KEY
        key_id: $APP_STORE_CONNECT_KEY_IDENTIFIER
        issuer_id: $APP_STORE_CONNECT_ISSUER_ID
        submit_to_testflight: true
