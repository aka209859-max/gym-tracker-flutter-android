workflows:
  ios-release:
    name: "GYM MATCH iOS Release"
    max_build_duration: 30
    instance_type: mac_mini_m2
    
    environment:
      groups:
        - app_store_credentials      # TestFlight ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”¨
        - manual_code_signing         # æ‰‹å‹•ç½²åç”¨ï¼ˆæ–°è¦è¿½åŠ ï¼‰
      
      vars:
        PROJECT_ROOT: $CM_BUILD_DIR
        BUNDLE_ID: com.nexa.gymmatch
      
      flutter: stable
      xcode: latest
      cocoapods: default
    
    scripts:
      - name: Clean Flutter
        script: |
          flutter clean
          flutter pub get
      
      - name: Clean CocoaPods cache and force fresh install
        script: |
          echo "ğŸ§¹ Cleaning iOS Pod environment..."
          cd ios
          rm -rf Podfile.lock Pods
          pod install --repo-update
          cd ..
          echo "âœ… Pod environment cleanup and update completed"
      
      - name: Install Pods
        script: |
          cd ios
          pod install
          cd ..
      
      # ğŸ” ã€é‡è¦ã€‘Keychainã‚’åˆæœŸåŒ–
      - name: Set up keychain
        script: |
          keychain initialize
      
      # ğŸ” ã€é‡è¦ã€‘Provisioning Profileã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«çµŒç”±)
      - name: Decode and install provisioning profile
        script: |
          set -e
          
          echo "'GymMatch AppStore Profile' ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã¾ã™..."
          
          PROFILES_HOME="$HOME/Library/MobileDevice/Provisioning Profiles"
          mkdir -p "$PROFILES_HOME"
          
          # ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ‡ã‚³ãƒ¼ãƒ‰
          echo "${CM_PROVISIONING_PROFILE}" | base64 --decode > /tmp/profile.mobileprovision
          
          # security cms ã§XMLå½¢å¼ã«å¤‰æ›
          security cms -D -i /tmp/profile.mobileprovision > /tmp/profile.plist
          
          # PlistBuddyã§UUIDæŠ½å‡ºï¼ˆãƒ•ã‚¡ã‚¤ãƒ«çµŒç”±ï¼‰
          PROFILE_UUID=$(/usr/libexec/PlistBuddy -c 'Print :UUID' /tmp/profile.plist)
          
          if [ -z "$PROFILE_UUID" ]; then
            echo "ã‚¨ãƒ©ãƒ¼: ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰UUIDã®æŠ½å‡ºã«å¤±æ•—ã—ã¾ã—ãŸã€‚"
            echo "ãƒ‡ãƒãƒƒã‚°æƒ…å ±:"
            ls -la /tmp/profile.*
            head -20 /tmp/profile.plist
            exit 1
          fi
          
          echo "æŠ½å‡ºã•ã‚ŒãŸãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«UUID: $PROFILE_UUID"
          
          # UUIDã‚’ãƒ•ã‚¡ã‚¤ãƒ«åã¨ã—ã¦æ­£ã—ã„å ´æ‰€ã«ä¿å­˜
          cp /tmp/profile.mobileprovision "$PROFILES_HOME/$PROFILE_UUID.mobileprovision"
          
          echo "ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£å¸¸ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¾ã—ãŸ: $PROFILES_HOME/$PROFILE_UUID.mobileprovision"
          
          # æ¤œè¨¼
          ls -la "$PROFILES_HOME/$PROFILE_UUID.mobileprovision"
      
      # ğŸ” ã€é‡è¦ã€‘è¨¼æ˜æ›¸ã‚’Keychainã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Decode and install certificate
        script: |
          set -x
          echo "$CM_CERTIFICATE" | base64 --decode > /tmp/certificate.p12
          keychain add-certificates \
            --certificate /tmp/certificate.p12 \
            --certificate-password "$CM_CERTIFICATE_PASSWORD"
          echo "âœ… Certificate installed to keychain"
      
      # ğŸ”§ ã€é‡è¦ã€‘pbxprojãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§æ‰‹å‹•ç½²åè¨­å®š (è¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆæ¨å¥¨)
      - name: Configure manual code signing in Xcode project
        script: |
          set -e
          
          echo "Xcode ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«æ‰‹å‹•ç½²åè¨­å®šã‚’é©ç”¨ã—ã¦ã„ã¾ã™..."
          
          pip3 install pbxproj
          
          python3 << 'PYTHON_SCRIPT'
          import sys
          from pbxproj import XcodeProject
          
          PROJECT_PATH = 'ios/Runner.xcodeproj/project.pbxproj'
          TEAM_ID = 'AXZBK8B732'
          PROFILE_NAME = 'GymMatch AppStore Profile'
          
          try:
              print(f'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰ä¸­: {PROJECT_PATH}')
              project = XcodeProject.load(PROJECT_PATH)
          except Exception as e:
              print(f'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: {e}')
              sys.exit(1)
          
          print('ãƒ“ãƒ«ãƒ‰æ§‹æˆã‚’æ‰‹å‹•ç½²åç”¨ã«å¤‰æ›´ä¸­...')
          
          modified_configs = 0
          for config in project.objects.get_objects_in_section('XCBuildConfiguration'):
              # Release ã¨ Profile ã®ä¸¡æ–¹ã®æ§‹æˆã‚’å¯¾è±¡ã«ã—ã¾ã™
              if hasattr(config, 'name') and ('Release' in config.name or 'Profile' in config.name):
                  print(f'  -> æ§‹æˆã‚’ä¿®æ­£ä¸­: {config.name}')
                  if hasattr(config, 'buildSettings'):
                      settings = config.buildSettings
                      settings['CODE_SIGN_STYLE'] = 'Manual'
                      settings['DEVELOPMENT_TEAM'] = TEAM_ID
                      settings['PROVISIONING_PROFILE_SPECIFIER'] = f'"{PROFILE_NAME}"'
                      settings['CODE_SIGN_IDENTITY'] = '"Apple Distribution"'
                      modified_configs += 1
          
          if modified_configs == 0:
              print('è­¦å‘Š: Release ã¾ãŸã¯ Profile æ§‹æˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚')
          else:
              print(f'{modified_configs} å€‹ã®æ§‹æˆã‚’ä¿®æ­£ã—ã¾ã—ãŸã€‚')
          
          print('å¤‰æ›´ã‚’ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ä¸­...')
          project.save()
          print('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ç½²åè¨­å®šãŒæ­£å¸¸ã«é©ç”¨ã•ã‚Œã¾ã—ãŸã€‚')
          PYTHON_SCRIPT
      
      # ğŸ” ã€é‡è¦ã€‘ExportOptionsã‚’ç”Ÿæˆ (è¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆæ¨å¥¨)
      - name: Create ExportOptions.plist
        script: |
          set -e
          
          echo "æ‰‹å‹• AppStore ç½²åç”¨ã® ExportOptions.plist ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™..."
          
          cat > $CM_BUILD_DIR/ExportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store</string>
              <key>signingStyle</key>
              <string>manual</string>
              <key>provisioningProfiles</key>
              <dict>
                  <key>com.nexa.gymmatch</key>
                  <string>GymMatch AppStore Profile</string>
              </dict>
              <key>signingCertificate</key>
              <string>Apple Distribution</string>
              <key>teamID</key>
              <string>AXZBK8B732</string>
          </dict>
          </plist>
          EOF
          echo "âœ… ExportOptions.plist created"
      
      # ğŸš€ ã€é‡è¦ã€‘Flutterã«ã‚ˆã‚‹IPAã®ãƒ“ãƒ«ãƒ‰ï¼ˆè¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆæ¨å¥¨ï¼‰
      - name: Flutter build ipa
        script: |
          set -e
          
          echo "Flutter IPA ãƒ“ãƒ«ãƒ‰ã‚’é–‹å§‹ã—ã¾ã™..."
          
          flutter build ipa --release \
            --export-options-plist=$CM_BUILD_DIR/ExportOptions.plist \
            --build-name=1.0.$PROJECT_BUILD_NUMBER \
            --build-number=$PROJECT_BUILD_NUMBER
          
          echo "Flutter IPA ãƒ“ãƒ«ãƒ‰ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚"
      
      # âœ… ã€æ¤œè¨¼ã€‘IPAãŒå®Ÿéš›ã«ç”Ÿæˆã•ã‚ŒãŸã‹æ¤œè¨¼
      - name: Verify IPA exists
        script: |
          echo "Verifying IPA file presence..."
          IPA_PATH=$(find "$PROJECT_ROOT/build/ios/ipa" -name "*.ipa" | head -n 1)
          if [ -z "$IPA_PATH" ]; then
            echo "::error:: IPA file was not generated in build/ios/ipa/"
            exit 1
          else
            echo "âœ… IPA found at: $IPA_PATH"
          fi
    
    artifacts:
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
      - flutter_drive.log
    
    publishing:
      # ğŸ“§ Eãƒ¡ãƒ¼ãƒ«é€šçŸ¥
      email:
        recipients:
          - aka209859@gmail.com
        notify:
          success: true
          failure: true
      
      # ğŸš€ ã€æœ€çµ‚ç›®çš„ã€‘TestFlightã¸ã®è‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      app_store_connect:
        api_key: $APP_STORE_CONNECT_PRIVATE_KEY
        key_id: $APP_STORE_CONNECT_KEY_IDENTIFIER
        issuer_id: $APP_STORE_CONNECT_ISSUER_ID
        submit_to_testflight: true
