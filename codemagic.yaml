workflows:
  ios-release:
    name: "GYM MATCH iOS Release"
    max_build_duration: 30
    instance_type: mac_mini_m2
    
    environment:
      groups:
        - app_store_credentials
      
      vars:
        PROJECT_ROOT: $CM_BUILD_DIR
        APP_STORE_CONNECT_ISSUER_ID: 089530c4-f36e-4828-8198-eec5ae23ad19
        APP_STORE_CONNECT_KEY_IDENTIFIER: DFXAU88R2R
        # APP_STORE_CONNECT_PRIVATE_KEY: Set as secure variable in Codemagic UI
      
      flutter: stable
      xcode: latest
      cocoapods: default
    
    scripts:
      - name: Clean Flutter
        script: |
          flutter clean
          flutter pub get
      
      - name: Clean CocoaPods cache and force fresh install
        script: |
          echo "ğŸ§¹ Cleaning iOS Pod environment..."
          cd ios
          rm -rf Podfile.lock Pods
          pod install --repo-update
          cd ..
          echo "âœ… Pod environment cleanup and update completed"
      
      - name: Install Pods
        script: |
          cd ios
          pod install
          cd ..
      
      # ğŸ”‘ ã€é‡è¦ã€‘App Store Connect APIã‚­ãƒ¼ã§ç½²åãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
      - name: Fetch signing files
        script: |
          app-store-connect fetch-signing-files $(xcode-project get-bundle-id --project ios/Runner.xcworkspace) \
            --issuer-id $APP_STORE_CONNECT_ISSUER_ID \
            --key-id $APP_STORE_CONNECT_KEY_IDENTIFIER \
            --private-key "$APP_STORE_CONNECT_PRIVATE_KEY" \
            --type IOS_APP_STORE \
            --create
      
      # ğŸš€ ã€é‡è¦ã€‘Flutterã«ã‚ˆã‚‹IPAã®ãƒ“ãƒ«ãƒ‰
      # --release ãƒ•ãƒ©ã‚°ãŒå¿…é ˆ
      # $PROJECT_BUILD_NUMBER ã¯CodemagicãŒæä¾›ã™ã‚‹ãƒ“ãƒ«ãƒ‰ç•ªå·
      - name: Flutter build ipa
        script: |
          flutter build ipa --release \
            --build-name=1.0.$PROJECT_BUILD_NUMBER \
            --build-number=$PROJECT_BUILD_NUMBER
      
      # âœ… ã€æ¤œè¨¼ã€‘ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ï¼šIPAãŒå®Ÿéš›ã«ç”Ÿæˆã•ã‚ŒãŸã‹æ¤œè¨¼
      # ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆãŒç„¡ã„ã¾ã¾å¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã‚€ã®ã‚’é˜²ã
      - name: Verify IPA exists
        script: |
          echo "Verifying IPA file presence..."
          IPA_PATH=$(find "$PROJECT_ROOT/build/ios/ipa" -name "*.ipa" | head -n 1)
          if [ -z "$IPA_PATH" ]; then
            echo "::error:: IPA file was not generated in build/ios/ipa/"
            exit 1
          else
            echo "âœ… IPA found at: $IPA_PATH"
          fi
    
    artifacts:
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
      - flutter_drive.log
    
    publishing:
      # ğŸ“§ Eãƒ¡ãƒ¼ãƒ«é€šçŸ¥ (ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆãŒæ•æ‰ã•ã‚Œã‚‹ãŸã‚ã€ä»Šåº¦ã¯ãƒªãƒ³ã‚¯ãŒé€ä¿¡ã•ã‚Œã‚‹)
      email:
        recipients:
          - aka209859@gmail.com
        notify:
          success: true
          failure: true
      
      # ğŸš€ ã€æœ€çµ‚ç›®çš„ã€‘TestFlightã¸ã®è‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      app_store_connect:
        api_key: $APP_STORE_CONNECT_PRIVATE_KEY
        key_id: $APP_STORE_CONNECT_KEY_IDENTIFIER
        issuer_id: $APP_STORE_CONNECT_ISSUER_ID
        submit_to_testflight: true
